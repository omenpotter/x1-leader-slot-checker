<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>X1 Leader Slot Checker</title>
<meta name="description" content="Real-time leader slot checker for X1 Mainnet validators. Find your next block production slot instantly."/>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg: #04070f;
    --surface: #0b1120;
    --border: #1a2a45;
    --accent: #00f5c4;
    --accent2: #0088ff;
    --warn: #ffaa00;
    --danger: #ff4466;
    --text: #c8deff;
    --muted: #4a6080;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,245,196,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,245,196,0.03) 1px, transparent 1px);
    background-size: 48px 48px;
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    top: -200px; left: -200px;
    width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(0,136,255,0.08) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  .orb2 {
    position: fixed;
    bottom: -200px; right: -200px;
    width: 500px; height: 500px;
    background: radial-gradient(circle, rgba(0,245,196,0.06) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
  nav {
    position: relative;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 28px;
    border-bottom: 1px solid var(--border);
    background: rgba(4,7,15,0.9);
    backdrop-filter: blur(14px);
    gap: 12px;
  }

  .nav-left {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }

  .nav-link {
    font-family: 'Syne', sans-serif;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-decoration: none;
    padding: 6px 11px;
    border-radius: 8px;
    border: 1px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .nav-link:hover {
    color: var(--accent);
    border-color: rgba(0,245,196,0.2);
    background: rgba(0,245,196,0.06);
  }

  /* Dropdown */
  .nav-dropdown { position: relative; }

  .nav-dropdown-btn {
    font-family: 'Syne', sans-serif;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    background: none;
    border: 1px solid transparent;
    border-radius: 8px;
    padding: 6px 11px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .nav-dropdown-btn:hover,
  .nav-dropdown.open .nav-dropdown-btn {
    color: var(--accent);
    border-color: rgba(0,245,196,0.2);
    background: rgba(0,245,196,0.06);
  }

  .chevron { transition: transform 0.2s; }
  .nav-dropdown.open .chevron { transform: rotate(180deg); }

  .nav-dropdown-menu {
    display: none;
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    left: auto;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 6px;
    min-width: 148px;
    z-index: 200;
    box-shadow: 0 12px 40px rgba(0,0,0,0.5);
  }

  .nav-dropdown.open .nav-dropdown-menu { display: block; }

  .nav-dropdown-menu a {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 9px 12px;
    border-radius: 7px;
    font-family: 'Syne', sans-serif;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-decoration: none;
    transition: all 0.15s;
  }

  .nav-dropdown-menu a:hover {
    background: rgba(0,245,196,0.08);
    color: var(--accent);
  }

  .nav-divider {
    width: 1px;
    height: 16px;
    background: var(--border);
    margin: 0 3px;
    flex-shrink: 0;
  }

  /* Icon-only links */
  .icon-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 34px; height: 34px;
    border-radius: 8px;
    border: 1px solid var(--border);
    color: var(--muted);
    text-decoration: none;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .icon-link:hover {
    border-color: rgba(0,245,196,0.3);
    color: var(--accent);
    background: rgba(0,245,196,0.06);
  }

  .icon-link svg {
    width: 15px; height: 15px;
    fill: currentColor;
    display: block;
  }

  /* ‚îÄ‚îÄ CONTAINER ‚îÄ‚îÄ */
  .container {
    position: relative;
    z-index: 1;
    max-width: 760px;
    margin: 0 auto;
    padding: 48px 24px 80px;
  }

  header { text-align: center; margin-bottom: 48px; }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(0,245,196,0.08);
    border: 1px solid rgba(0,245,196,0.2);
    border-radius: 100px;
    padding: 6px 16px;
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 20px;
  }

  .badge::before {
    content: '';
    width: 6px; height: 6px;
    background: var(--accent);
    border-radius: 50%;
    animation: pulse 2s ease-in-out infinite;
  }

  h1 {
    font-size: clamp(28px, 5vw, 48px);
    font-weight: 800;
    line-height: 1.1;
    letter-spacing: -1px;
    color: #fff;
  }

  h1 span { color: var(--accent); }

  .subtitle {
    margin-top: 12px;
    font-size: 15px;
    color: var(--muted);
    font-weight: 400;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 20px;
    transition: border-color 0.3s;
  }

  .card:hover { border-color: rgba(0,245,196,0.2); }

  .card-label {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--muted);
    margin-bottom: 12px;
  }

  .input-group { display: flex; flex-direction: column; gap: 14px; }
  .field { display: flex; flex-direction: column; gap: 6px; }

  label {
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  input {
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    color: #fff;
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    width: 100%;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,245,196,0.1);
  }

  input::placeholder { color: var(--muted); }

  .btn {
    width: 100%;
    padding: 16px;
    border: none;
    border-radius: 12px;
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.5px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #000;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,245,196,0.3);
  }

  .btn-primary:active { transform: translateY(0); }

  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .slot-meter { display: flex; align-items: center; gap: 12px; margin-top: 8px; }

  .meter-bar {
    flex: 1; height: 4px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
  }

  .meter-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.8s ease, background 0.5s;
  }

  .results-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }

  @media (max-width: 500px) { .results-grid { grid-template-columns: 1fr; } }

  .stat-card {
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }

  .stat-card.highlight {
    border-color: rgba(0,245,196,0.3);
    background: rgba(0,245,196,0.04);
  }

  .stat-card.full-width { grid-column: 1 / -1; }

  .stat-label {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .stat-value {
    font-family: 'Space Mono', monospace;
    font-size: 22px;
    font-weight: 700;
    color: #fff;
    line-height: 1.2;
  }

  .stat-value.accent { color: var(--accent); }
  .stat-sub { font-size: 11px; color: var(--muted); margin-top: 4px; }

  .countdown { display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap; }
  .countdown-unit { text-align: center; }

  .countdown-num {
    font-family: 'Space Mono', monospace;
    font-size: 36px;
    font-weight: 700;
    color: var(--accent);
    display: block;
    line-height: 1;
  }

  .countdown-label {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .countdown-sep {
    font-size: 28px;
    color: var(--border);
    padding-bottom: 8px;
    font-family: 'Space Mono', monospace;
  }

  .epoch-progress { margin-top: 12px; }

  .epoch-bar {
    height: 6px;
    background: var(--border);
    border-radius: 6px;
    overflow: hidden;
    margin-top: 8px;
  }

  .epoch-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    border-radius: 6px;
    transition: width 0.8s ease;
  }

  .status-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 13px;
    margin-bottom: 16px;
  }

  .status-row.measuring { background: rgba(255,170,0,0.08); border: 1px solid rgba(255,170,0,0.2); color: var(--warn); }
  .status-row.fetching  { background: rgba(0,136,255,0.08);  border: 1px solid rgba(0,136,255,0.2);  color: var(--accent2); }
  .status-row.done      { background: rgba(0,245,196,0.08);  border: 1px solid rgba(0,245,196,0.2);  color: var(--accent); }
  .status-row.error     { background: rgba(255,68,102,0.08);  border: 1px solid rgba(255,68,102,0.2);  color: var(--danger); }

  .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

  .dot.spin {
    border: 2px solid currentColor;
    border-top-color: transparent;
    animation: spin 0.8s linear infinite;
    width: 10px; height: 10px;
  }

  .log {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    line-height: 1.8;
    padding: 16px;
    background: rgba(0,0,0,0.3);
    border-radius: 8px;
    border: 1px solid var(--border);
    max-height: 140px;
    overflow-y: auto;
  }

  .log-line { display: flex; gap: 8px; }
  .log-time { color: rgba(0,245,196,0.4); flex-shrink: 0; }
  .log-msg { color: var(--muted); }
  .log-msg.ok  { color: rgba(0,245,196,0.7); }
  .log-msg.err { color: var(--danger); }

  .no-slots { text-align: center; padding: 32px; }
  .no-slots .icon { font-size: 40px; margin-bottom: 12px; }
  .no-slots h3 { color: #fff; margin-bottom: 8px; }
  .no-slots p  { color: var(--muted); font-size: 14px; }

  .slot-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }

  .slot-pill {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 4px;
    background: rgba(0,136,255,0.1);
    border: 1px solid rgba(0,136,255,0.2);
    color: var(--accent2);
  }

  .slot-pill.next {
    background: rgba(0,245,196,0.15);
    border-color: rgba(0,245,196,0.4);
    color: var(--accent);
  }

  .hidden { display: none; }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50%       { opacity: 0.5; transform: scale(0.8); }
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .animate-in { animation: fadeIn 0.4s ease forwards; }

  footer {
    text-align: center;
    margin-top: 48px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
    font-size: 12px;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    line-height: 2;
  }

  footer a { color: var(--accent); text-decoration: none; }
  footer a:hover { text-decoration: underline; }

  @media (max-width: 620px) {
    nav { padding: 10px 14px; gap: 8px; }
    .nav-link { padding: 5px 8px; font-size: 11px; }
    .nav-dropdown-btn { padding: 5px 8px; font-size: 11px; }
  }
</style>
</head>
<body>
<div class="orb2"></div>

<!-- ‚îÄ‚îÄ NAV ‚îÄ‚îÄ -->
<nav>
  <div class="nav-left">

    <!-- X (Twitter) -->
    <a href="https://x.com/rkbehelvi" target="_blank" rel="noopener" class="icon-link" title="Follow on X">
      <svg viewBox="0 0 24 24">
        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.748l7.73-8.835L1.254 2.25H8.08l4.259 5.632L18.244 2.25zm-1.161 17.52h1.833L7.084 4.126H5.117L17.083 19.77z"/>
      </svg>
    </a>

    <!-- Telegram -->
    <a href="https://t.me/+HtiLywX2Dug3MjJk" target="_blank" rel="noopener" class="icon-link" title="Join Telegram">
      <svg viewBox="0 0 24 24">
        <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
      </svg>
    </a>

  </div>

  <div class="nav-right">

    <!-- Launch my Validator dropdown -->
    <div class="nav-dropdown" id="launchDropdown">
      <button class="nav-dropdown-btn" onclick="toggleDropdown()">
        Launch my Validator
        <svg class="chevron" width="12" height="12" viewBox="0 0 12 12" fill="none">
          <path d="M2 4l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div class="nav-dropdown-menu">
        <a href="https://docs.x1.xyz/validating/create-a-read-only-node" target="_blank" rel="noopener">
          üìÑ Manual
        </a>
        <a href="https://github.com/BlackBeard085/x1console" target="_blank" rel="noopener">
          ‚ö° One Liner
        </a>
      </div>
    </div>

    <div class="nav-divider"></div>

    <a href="https://x1valhq.xyz/" target="_blank" rel="noopener" class="nav-link">
      Manage Validator
    </a>

    <div class="nav-divider"></div>

    <a href="https://x1space.xyz/validators" target="_blank" rel="noopener" class="nav-link">
      Explorer
    </a>

  </div>
</nav>

<!-- ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ -->
<div class="container">

  <header>
    <div class="badge">X1 Mainnet</div>
    <h1>X1 Leader Slot<br/><span>Checker</span></h1>
    <p class="subtitle">Find your validator's next block production slot in real-time</p>
  </header>

  <div class="card">
    <div class="card-label">// Configuration</div>
    <div class="input-group">
      <div class="field">
        <label>Validator Identity Pubkey</label>
        <input type="text" id="pubkey"
          placeholder="Enter your validator identity pubkey..."/>
      </div>
      <button class="btn btn-primary" id="checkBtn" onclick="runCheck()">
        Check Leader Slots
      </button>
    </div>
  </div>

  <div id="resultsSection" class="hidden">

    <div class="card">
      <div class="card-label">// Live Log</div>
      <div id="statusRow" class="status-row fetching">
        <div class="dot spin"></div>
        <span>Initializing...</span>
      </div>
      <div class="log" id="logBox"></div>
    </div>

    <div id="mainStats" class="hidden">

      <div class="card animate-in">
        <div class="card-label">// Slot Timing</div>
        <div class="results-grid" style="margin-bottom:16px">
          <div class="stat-card">
            <div class="stat-label">Live Slot Time</div>
            <div class="stat-value accent" id="slotMs">‚Äî</div>
            <div class="stat-sub">ms per slot (measured)</div>
            <div class="slot-meter">
              <div class="meter-bar">
                <div class="meter-fill" id="slotMeterFill" style="width:0%"></div>
              </div>
              <span id="slotQuality" style="font-size:11px;color:var(--muted)">‚Äî</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Current Slot</div>
            <div class="stat-value" id="currentSlot">‚Äî</div>
            <div class="stat-sub" id="epochInfo">Epoch ‚Äî</div>
          </div>
        </div>
        <div class="epoch-progress">
          <div class="stat-label">Epoch Progress</div>
          <div class="epoch-bar">
            <div class="epoch-fill" id="epochFill" style="width:0%"></div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:4px">
            <span style="font-size:11px;color:var(--muted)" id="epochPct">0%</span>
            <span style="font-size:11px;color:var(--muted)" id="epochSlots">‚Äî slots remaining</span>
          </div>
        </div>
      </div>

      <div id="noSlotsCard" class="card hidden animate-in">
        <div class="no-slots">
          <div class="icon">‚è≥</div>
          <h3>No upcoming slots this epoch</h3>
          <p>All leader slots for this epoch have passed or none were assigned.<br/>
          The schedule rotates approximately every 2 days.</p>
        </div>
      </div>

      <div id="nextSlotCard" class="card animate-in hidden">
        <div class="card-label">// Next Leader Slot</div>
        <div class="results-grid">
          <div class="stat-card highlight full-width">
            <div class="stat-label">Time Until Next Block</div>
            <div class="countdown">
              <div class="countdown-unit">
                <span class="countdown-num" id="ctHours">00</span>
                <span class="countdown-label">Hours</span>
              </div>
              <span class="countdown-sep">:</span>
              <div class="countdown-unit">
                <span class="countdown-num" id="ctMins">00</span>
                <span class="countdown-label">Minutes</span>
              </div>
              <span class="countdown-sep">:</span>
              <div class="countdown-unit">
                <span class="countdown-num" id="ctSecs">00</span>
                <span class="countdown-label">Seconds</span>
              </div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Next Slot #</div>
            <div class="stat-value accent" id="nextSlotNum">‚Äî</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Slots Remaining</div>
            <div class="stat-value" id="slotsRemaining">‚Äî</div>
          </div>
          <div class="stat-card full-width">
            <div class="stat-label">Upcoming Slots This Epoch</div>
            <div class="slot-list" id="slotList"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <footer>
    Built for X1 Blockchain
  </footer>
</div>

<script>
  var countdownInterval = null;
  var msPerSlot = 400;

  function toggleDropdown() {
    document.getElementById('launchDropdown').classList.toggle('open');
  }
  document.addEventListener('click', function(e) {
    var dd = document.getElementById('launchDropdown');
    if (!dd.contains(e.target)) dd.classList.remove('open');
  });

  function log(msg, type) {
    type = type || '';
    var box = document.getElementById('logBox');
    var now = new Date().toLocaleTimeString('en-US', {hour12:false});
    var line = document.createElement('div');
    line.className = 'log-line';
    var t = document.createElement('span');
    t.className = 'log-time';
    t.textContent = '[' + now + ']';
    var m = document.createElement('span');
    m.className = 'log-msg' + (type ? ' ' + type : '');
    m.textContent = msg;
    line.appendChild(t);
    line.appendChild(m);
    box.appendChild(line);
    box.scrollTop = box.scrollHeight;
  }

  function setStatus(text, type) {
    type = type || 'fetching';
    var row = document.getElementById('statusRow');
    row.className = 'status-row ' + type;
    var dot = type === 'done'  ? '<div class="dot" style="background:var(--accent)"></div>'
            : type === 'error' ? '<div class="dot" style="background:var(--danger)"></div>'
            : '<div class="dot spin"></div>';
    row.innerHTML = dot + '<span>' + text + '</span>';
  }

  // Sends a JSON-RPC batch ‚Äî multiple methods in ONE http round trip
  function rpcBatch(calls) {
    var batch = calls.map(function(c, i) {
      return { jsonrpc: '2.0', id: i + 1, method: c.method, params: c.params || [] };
    });
    return fetch('/api/rpc', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(batch)
    }).then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }).then(function(arr) {
      // Results may come back out of order ‚Äî sort by id
      arr.sort(function(a, b) { return a.id - b.id; });
      return arr.map(function(r) {
        if (r.error) throw new Error(r.error.message);
        return r.result;
      });
    });
  }

  function runCheck() {
    var pubkey = document.getElementById('pubkey').value.trim();
    if (!pubkey) { alert('Please enter a validator pubkey.'); return; }

    document.getElementById('resultsSection').classList.remove('hidden');
    document.getElementById('mainStats').classList.add('hidden');
    document.getElementById('noSlotsCard').classList.add('hidden');
    document.getElementById('nextSlotCard').classList.add('hidden');
    document.getElementById('logBox').innerHTML = '';
    document.getElementById('checkBtn').disabled = true;
    if (countdownInterval) clearInterval(countdownInterval);

    setStatus('Loading chain data...', 'fetching');
    log('Fetching slot, epoch info and leader schedule in one request...');

    var epochStart, myRelSlots, slot1, t1;

    // ROUND TRIP 1: get everything we need upfront ‚Äî slot + epochInfo + schedule
    rpcBatch([
      { method: 'getSlot' },
      { method: 'getEpochInfo' },
      { method: 'getLeaderSchedule' }
    ]).then(function(results) {
      slot1 = results[0];
      t1 = Date.now();
      var epochInfo = results[1];
      var schedule  = results[2];

      log('Got slot ' + slot1.toLocaleString() + ', epoch info and schedule', 'ok');

      var slotIndex    = epochInfo.slotIndex;
      var absSlot      = epochInfo.absoluteSlot;
      var slotsInEpoch = epochInfo.slotsInEpoch;
      epochStart       = absSlot - slotIndex;
      var epochNum     = epochInfo.epoch;
      var epochPct     = Math.round((slotIndex / slotsInEpoch) * 100);
      var slotsLeft    = slotsInEpoch - slotIndex;

      log('Epoch ' + epochNum + ' | ' + epochPct + '% complete', 'ok');

      document.getElementById('currentSlot').textContent = absSlot.toLocaleString();
      document.getElementById('epochInfo').textContent   = 'Epoch ' + epochNum;
      document.getElementById('epochFill').style.width   = epochPct + '%';
      document.getElementById('epochPct').textContent    = epochPct + '%';
      document.getElementById('epochSlots').textContent  = slotsLeft.toLocaleString() + ' slots remaining';

      if (!schedule) throw new Error('getLeaderSchedule returned null');
      myRelSlots = schedule[pubkey];

      if (!myRelSlots || myRelSlots.length === 0) {
        log('No leader slots for ' + pubkey.slice(0, 8) + '...', 'err');
        setStatus('Done - no slots this epoch', 'done');
        document.getElementById('slotMs').textContent = '‚Äî';
        document.getElementById('mainStats').classList.remove('hidden');
        document.getElementById('noSlotsCard').classList.remove('hidden');
        document.getElementById('checkBtn').disabled = false;
        return null; // stop chain
      }

      log('Found ' + myRelSlots.length + ' slots. Waiting 3s to measure slot speed...');
      setStatus('Measuring slot time...', 'measuring');

      // SLEEP 3s ‚Äî only intentional delay, everything else already done
      return new Promise(function(r) { setTimeout(r, 3000); });

    }).then(function(sentinel) {
      if (sentinel === null) return; // no slots case ‚Äî stop

      // ROUND TRIP 2: single getSlot for slot2 ‚Äî this is our countdown anchor
      return fetch('/api/rpc', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: 'getSlot', params: [] })
      }).then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.error) throw new Error(data.error.message);
          var slot2 = data.result;
          var t2 = Date.now();

          var slotDiff = slot2 - slot1;
          var timeDiff = t2 - t1;
          msPerSlot = slotDiff > 0 ? Math.round(timeDiff / slotDiff) : 400;

          log('Slot2: ' + slot2.toLocaleString() + ' | ' + slotDiff + ' slots in ' + timeDiff + 'ms = ' + msPerSlot + 'ms/slot', 'ok');

          document.getElementById('slotMs').textContent = msPerSlot + 'ms';
          var quality   = msPerSlot < 420 ? 'Fast' : msPerSlot < 480 ? 'Normal' : 'Slow';
          var fillPct   = Math.min(100, Math.max(0, ((500 - msPerSlot) / 200) * 100));
          var fillColor = msPerSlot < 420 ? 'var(--accent)' : msPerSlot < 480 ? 'var(--warn)' : 'var(--danger)';
          document.getElementById('slotMeterFill').style.width      = fillPct + '%';
          document.getElementById('slotMeterFill').style.background = fillColor;
          document.getElementById('slotQuality').textContent        = quality;

          // Filter upcoming slots ‚Äî anchor to slot2/t2 which is freshest
          var upcoming = myRelSlots
            .map(function(rel) { return epochStart + rel; })
            .filter(function(abs) { return abs > slot2; })
            .sort(function(a, b) { return a - b; });

          if (upcoming.length === 0) {
            log('All assigned slots have passed this epoch', 'err');
            setStatus('Done - all slots passed', 'done');
            document.getElementById('mainStats').classList.remove('hidden');
            document.getElementById('noSlotsCard').classList.remove('hidden');
            document.getElementById('checkBtn').disabled = false;
            return;
          }

          var nextSlot  = upcoming[0];
          var diff      = nextSlot - slot2;
          var totalSecs = Math.round(diff * msPerSlot / 1000);
          log('Next slot: ' + nextSlot.toLocaleString() + ' (~' + Math.floor(totalSecs / 60) + 'm ' + (totalSecs % 60) + 's)', 'ok');

          var slotList = document.getElementById('slotList');
          slotList.innerHTML = '';
          upcoming.slice(0, 20).forEach(function(s, i) {
            var pill = document.createElement('span');
            pill.className = 'slot-pill' + (i === 0 ? ' next' : '');
            pill.textContent = s.toLocaleString();
            slotList.appendChild(pill);
          });
          if (upcoming.length > 20) {
            var more = document.createElement('span');
            more.className = 'slot-pill';
            more.textContent = '+' + (upcoming.length - 20) + ' more';
            slotList.appendChild(more);
          }

          document.getElementById('nextSlotNum').textContent    = nextSlot.toLocaleString();
          document.getElementById('slotsRemaining').textContent = diff.toLocaleString();

          // Countdown anchored to slot2/t2 ‚Äî no drift possible
          startCountdown(diff, msPerSlot, t2);
          setStatus('Live - countdown active', 'done');
          document.getElementById('mainStats').classList.remove('hidden');
          document.getElementById('nextSlotCard').classList.remove('hidden');
          document.getElementById('checkBtn').disabled = false;
        });

    }).catch(function(e) {
      log('Error: ' + e.message, 'err');
      setStatus('Error - ' + e.message, 'error');
      console.error(e);
      document.getElementById('checkBtn').disabled = false;
    });
  }

  function startCountdown(initialDiff, ms, startTime) {
    if (countdownInterval) clearInterval(countdownInterval);
    function tick() {
      var elapsed      = Date.now() - startTime;
      var elapsedSlots = Math.floor(elapsed / ms);
      var remaining    = Math.max(0, initialDiff - elapsedSlots);
      var remainSecs   = Math.max(0, Math.round(remaining * ms / 1000));
      var h = Math.floor(remainSecs / 3600);
      var m = Math.floor((remainSecs % 3600) / 60);
      var s = remainSecs % 60;
      document.getElementById('ctHours').textContent        = String(h).padStart(2, '0');
      document.getElementById('ctMins').textContent         = String(m).padStart(2, '0');
      document.getElementById('ctSecs').textContent         = String(s).padStart(2, '0');
      document.getElementById('slotsRemaining').textContent = remaining.toLocaleString();
      if (remainSecs <= 0) {
        clearInterval(countdownInterval);
        setStatus('Leader slot reached!', 'done');
      }
    }
    tick();
    countdownInterval = setInterval(tick, 1000);
  }
</script>
</body>
</html>
